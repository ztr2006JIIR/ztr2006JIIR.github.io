<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>张天一升学宴邀请函</title>
  <style>
    /* 基本样式保留并微调 */
    :root{--gold:#d4af37;--gold-dark:#c9a227;}
    body{font-family:"Microsoft YaHei",sans-serif;background:#f9f3e9;margin:0;padding:0;
      background-image:url('https://img.freepik.com/free-vector/elegant-gold-background_52683-62728.jpg');
      background-size:cover;background-attachment:fixed;color:#333;}
    .container{max-width:800px;margin:50px auto;padding:30px;background:rgba(255,255,255,0.95);
      border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.1);position:relative;overflow:hidden;}
    .header{text-align:center;margin-bottom:30px}
    .title{font-size:48px;color:var(--gold);text-shadow:2px 2px 4px rgba(0,0,0,.2);font-weight:700;margin:20px 0}
    .divider{height:3px;background:linear-gradient(to right,transparent,var(--gold),transparent);margin:20px 0}
    .content{font-size:18px;line-height:1.8;text-align:justify}
    .highlight{color:var(--gold);font-weight:700}
    .footer{text-align:right;margin-top:40px;font-size:16px;position:relative}
    .btn-container{text-align:center;margin-top:40px}
    .btn{display:inline-block;padding:12px 30px;background:var(--gold);color:#fff;border-radius:50px;border:0;
      cursor:pointer;font-size:18px;box-shadow:0 4px 8px rgba(0,0,0,.1);margin:5px;transition:all .18s}
    .btn:hover{background:var(--gold-dark);transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.12)}
    .btn.admin{background:#6c757d;position:absolute;right:0;bottom:0;padding:8px 15px;font-size:14px}
    .btn.danger{background:#dc3545}
    /* 模态与遮罩 */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);
      z-index:10000;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
    .modal[aria-hidden="false"]{display:flex}
    .modal-content{background:#fff;width:100%;max-width:820px;border-radius:10px;padding:24px;box-shadow:0 8px 30px rgba(0,0,0,.2);
      max-height:90vh;overflow:auto;position:relative;z-index:10001}
    .close{position:absolute;right:18px;top:12px;font-size:26px;color:#666;cursor:pointer;border:0;background:none}
    .close:focus{outline:2px solid #ddd}
    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:8px;font-weight:700}
    input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:16px;box-sizing:border-box}
    textarea{resize:vertical}
    .guests-list{margin-top:20px;border-top:1px solid #eee;padding-top:20px}
    .guest-item{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .guest-info{flex:1}
    .guest-actions{margin-left:12px}
    .stats{display:flex;justify-content:space-around;margin-bottom:18px;font-size:18px}
    .stat-item{text-align:center;padding:10px;background:#f1f3f5;border-radius:6px;min-width:120px}
    .stat-value{font-size:22px;font-weight:700;color:var(--gold)}
    .admin-login{text-align:center;margin-top:6px}
    .password-input{margin:10px 0;padding:8px;width:220px;border-radius:6px;border:1px solid #ddd}
    .user-view{margin-top:30px}

    /* confetti: 不阻挡鼠标（pointer-events:none），并且 z-index 低于 modal */
    .confetti{position:absolute;width:8px;height:8px;border-radius:50%;opacity:.85;pointer-events:none;z-index:0}
    /* keyframes 将由 JS 动态插入，避免重复声明冲突 */
    @media (max-width:640px){ .title{font-size:32px} .container{padding:18px} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">升学宴</div>
      <div class="divider"></div>
    </div>

    <div class="content">
      <p>朋友圈的朋友们：</p>
      <p>你们好！</p>
      <p>春华秋实，硕果累累。在这个收获的季节里，我们怀着无比喜悦的心情与您分享一个好消息——小女
         <span class="highlight">张天一</span>经过多年的勤奋努力，在2025年高考中荣幸地被
         <span class="highlight">宁夏大学</span>录取。</p>
      <p>为了感谢各位亲朋好友一直以来的关心与支持，我们诚挚邀请您参加她的升学宴，共同见证这一重要时刻，分享我们的喜悦与感恩。</p>
      <p><strong>时间：</strong>2025年8月16日（星期五）中午</p>
      <p><strong>地点：</strong>吉寿楼（具体厅位可现场咨询）</p>
      <p>期待与您共聚一堂，同庆同乐！</p>
    </div>

    <div class="footer">
      <p>家长：<span class="highlight">张世盾、牛小合</span> 敬邀</p>
      <p>联系电话：13995440435，15709640855</p>
      <button class="btn admin" id="adminModeBtn" type="button">管理员模式</button>
    </div>

    <div class="btn-container">
      <button class="btn" id="attendBtn" type="button">参加宴会</button>
    </div>

    <div class="user-view" id="userView">
      <h3>我的报名信息</h3>
      <div id="myGuestsList"></div>
    </div>
  </div>

  <!-- 参加宴会模态 -->
  <div id="attendModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="attendTitle">
    <div class="modal-content" role="document">
      <button class="close" aria-label="关闭" id="attendCloseBtn">&times;</button>
      <h2 id="attendTitle">参加宴会登记</h2>
      <div class="form-group">
        <label for="name">您的姓名</label>
        <input id="name" type="text" placeholder="请输入您的姓名" />
      </div>
      <div class="form-group">
        <label for="phone">联系电话</label>
        <input id="phone" type="text" placeholder="请输入您的联系电话" />
      </div>
      <div class="form-group">
        <label for="count">参加人数</label>
        <input id="count" type="number" min="1" value="1" />
      </div>
      <div class="form-group">
        <label for="note">备注</label>
        <textarea id="note" rows="3" placeholder="如有特殊需求请在此备注"></textarea>
      </div>
      <div style="text-align:center;margin-top:6px">
        <button class="btn" id="submitBtn" type="button">提交</button>
      </div>
    </div>
  </div>

  <!-- 管理员面板模态 -->
  <div id="adminModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="adminTitle">
    <div class="modal-content" role="document">
      <button class="close" aria-label="关闭" id="adminCloseBtn">&times;</button>
      <h2 id="adminTitle">管理员面板</h2>
      <div class="stats">
        <div class="stat-item"><div>总条目</div><div class="stat-value" id="totalGuests">0</div></div>
        <div class="stat-item"><div>总宾客数</div><div class="stat-value" id="totalPeople">0</div></div>
      </div>
      <div class="guests-list" id="adminGuestsList"><h3>所有宾客名单</h3></div>
    </div>
  </div>

  <!-- 管理员登录模态 -->
  <div id="loginModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="loginTitle">
    <div class="modal-content" role="document">
      <button class="close" aria-label="关闭" id="loginCloseBtn">&times;</button>
      <h2 id="loginTitle">管理员登录</h2>
      <div class="admin-login">
        <p>请输入管理员密码</p>
        <input id="adminPassword" class="password-input" type="password" placeholder="密码" />
        <div style="margin-top:8px"><button class="btn" id="loginBtn" type="button">登录</button></div>
        <p id="loginError" style="color:red;display:none;margin-top:8px">密码错误，请重试</p>
      </div>
    </div>
  </div>

<script>
/*
  说明：所有交互绑定都在 DOMContentLoaded 中完成，确保元素存在。
  请不要把脚本提前移动到 <head>，保留在 body 底部即可。
*/

/* --- 配置 --- */
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwG1w3IWKSMgBAwL6pjiuWgrde_hzuv7YdAg6Z15_vtGnAX4A3LubPi3Hd1o5PNSNRt/exec';
const ADMIN_PASSWORD = '306000';

document.addEventListener('DOMContentLoaded', () => {
  // DOM 元素
  const attendBtn = document.getElementById('attendBtn');
  const adminModeBtn = document.getElementById('adminModeBtn');
  const attendModal = document.getElementById('attendModal');
  const adminModal = document.getElementById('adminModal');
  const loginModal = document.getElementById('loginModal');
  const submitBtn = document.getElementById('submitBtn');
  const loginBtn = document.getElementById('loginBtn');
  const adminGuestsList = document.getElementById('adminGuestsList');
  const totalGuests = document.getElementById('totalGuests');
  const totalPeople = document.getElementById('totalPeople');
  const myGuestsList = document.getElementById('myGuestsList');
  const loginError = document.getElementById('loginError');

  // close buttons
  const attendClose = document.getElementById('attendCloseBtn');
  const adminClose = document.getElementById('adminCloseBtn');
  const loginClose = document.getElementById('loginCloseBtn');

  // user id 存储
  let currentUser = localStorage.getItem('currentUser') || generateUserId();
  if (!localStorage.getItem('currentUser')) localStorage.setItem('currentUser', currentUser);

  // utility
  function generateUserId(){ return 'user_' + Math.random().toString(36).slice(2,10); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

  // show/hide helpers with aria
  function showModal(modal){
    modal.setAttribute('aria-hidden','false');
    // focus first focusable
    const focusable = modal.querySelector('input,button,textarea,[tabindex]:not([tabindex="-1"])');
    if (focusable) focusable.focus();
  }
  function hideModal(modal){
    modal.setAttribute('aria-hidden','true');
  }

  // Bind open/close
  attendBtn.addEventListener('click', ()=> showModal(attendModal));
  adminModeBtn.addEventListener('click', ()=> showModal(loginModal));

  // close handlers
  [attendClose, adminClose, loginClose].forEach(btn=>{
    if (btn) btn.addEventListener('click', (e)=> {
      const parent = e.target.closest('.modal');
      if (parent) hideModal(parent);
    });
  });

  // click outside content to close
  [attendModal, adminModal, loginModal].forEach(modal=>{
    modal.addEventListener('click', e=>{
      if (e.target === modal) hideModal(modal);
    });
  });

  // ESC to close
  document.addEventListener('keydown', e=>{
    if (e.key === 'Escape'){
      [attendModal, adminModal, loginModal].forEach(m=>m && showIfOpenHide(m));
    }
  });
  function showIfOpenHide(m){
    if (m && m.getAttribute('aria-hidden') === 'false') hideModal(m);
  }

  // Submit handler
  submitBtn.addEventListener('click', () => {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const count = document.getElementById('count').value;
    const note = document.getElementById('note').value.trim();

    if (!name || !phone){
      alert('请填写姓名和联系电话'); return;
    }

    const guest = { name, phone, count, note, time: new Date().toLocaleString(), userId: currentUser };

    // try send to Google Apps Script
    fetch(SHEET_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(guest)
    }).then(res=>{
      // some deployments return text, some JSON — 不强求解析
      // 清空表单
      document.getElementById('name').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('count').value = '1';
      document.getElementById('note').value = '';
      alert('提交成功！感谢您的参与！');
      hideModal(attendModal);
      loadUserGuests();
    }).catch(err=>{
      // 回退到 localStorage
      const guests = JSON.parse(localStorage.getItem('guests')||'[]');
      guests.push(guest);
      localStorage.setItem('guests', JSON.stringify(guests));
      localStorage.setItem('currentUser', guest.userId);
      alert('网络异常，记录已保存在本地。请联网后重试上传。');
      hideModal(attendModal);
      loadUserGuests();
    });
  });

  // login handler (front-end)
  loginBtn.addEventListener('click', ()=>{
    const pwd = document.getElementById('adminPassword').value;
    if (pwd === ADMIN_PASSWORD){
      loginError.style.display = 'none';
      document.getElementById('adminPassword').value = '';
      hideModal(loginModal);
      showModal(adminModal);
      loadAdminGuests();
    } else {
      loginError.style.display = 'block';
    }
  });

  // Delete functions (exposed)
  window.deleteGuest = function(row){
    if (!confirm('确定要删除这条记录吗？')) return;
    fetch(SHEET_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'delete', row})})
      .then(()=>{ loadAdminGuests(); loadUserGuests(); })
      .catch(()=> alert('删除失败，请检查网络或 Apps Script 权限'));
  };
  window.deleteLocalGuest = function(index){
    if (!confirm('确定要删除本地这条记录吗？')) return;
    const guests = JSON.parse(localStorage.getItem('guests')||'[]');
    guests.splice(index,1);
    localStorage.setItem('guests', JSON.stringify(guests));
    loadAdminGuests(); loadUserGuests();
  };

  /* --- Data loading & rendering --- */
  function loadAdminGuests(){
    adminGuestsList.innerHTML = '<h3>所有宾客名单</h3>';
    fetch(SHEET_URL).then(r=>r.json()).then(data=>{
      let rows = [];
      if (!data) data = [];
      if (Array.isArray(data) && data.length>0 && typeof data[0] === 'object' && !Array.isArray(data[0])){
        rows = data.map(o=>o);
      } else if (Array.isArray(data) && data.length>0 && Array.isArray(data[0])){
        const headers = data[0].map(h=>String(h));
        for (let i=1;i<data.length;i++){
          const r = data[i], obj={};
          for (let j=0;j<headers.length;j++) obj[headers[j]] = r[j];
          obj._row = i+1;
          rows.push(obj);
        }
      }
      renderAdminList(rows);
    }).catch(()=> {
      const guests = JSON.parse(localStorage.getItem('guests')||'[]');
      const rows = guests.map((g,idx)=>Object.assign({}, g, {_row:null}));
      renderAdminList(rows);
    });
  }

  function renderAdminList(rows){
    adminGuestsList.innerHTML = '<h3>所有宾客名单</h3>';
    if (!rows || rows.length===0){
      adminGuestsList.innerHTML += '<p>暂无宾客信息</p>';
      totalGuests.textContent = 0; totalPeople.textContent = 0; return;
    }
    let total = 0;
    rows.forEach(g=> total += parseInt(g.count)||0);
    totalGuests.textContent = rows.length; totalPeople.textContent = total;
    rows.forEach((guest,idx)=>{
      const div = document.createElement('div'); div.className='guest-item';
      const note = guest.note ? '<br>备注: '+escapeHtml(guest.note) : '';
      const time = guest.time ? '<br><small>'+escapeHtml(String(guest.time))+'</small>' : '';
      const rowNum = guest._row || '';
      div.innerHTML = `
        <div class="guest-info">
          <strong>${escapeHtml(guest.name||'')}</strong> (${escapeHtml(guest.phone||'')})<br>
          人数: ${escapeHtml(String(guest.count||'1'))}
          ${note}${time}
        </div>
        <div class="guest-actions">
          ${ rowNum ? `<button class="btn danger" onclick="deleteGuest(${rowNum})" type="button">删除</button>` : `<button class="btn danger" onclick="deleteLocalGuest(${idx})" type="button">删除(本地)</button>`}
        </div>
      `;
      adminGuestsList.appendChild(div);
    });
  }

  function loadUserGuests(){
    myGuestsList.innerHTML = '';
    fetch(SHEET_URL).then(r=>r.json()).then(data=>{
      let rows=[];
      if (Array.isArray(data) && data.length>0 && typeof data[0] === 'object' && !Array.isArray(data[0])) rows = data;
      else if (Array.isArray(data) && data.length>0 && Array.isArray(data[0])){
        const headers = data[0].map(h=>String(h));
        for (let i=1;i<data.length;i++){
          const r=data[i], obj={};
          for (let j=0;j<headers.length;j++) obj[headers[j]] = r[j];
          obj._row = i+1; rows.push(obj);
        }
      }
      const serverMy = rows.filter(g=>g.userId===currentUser);
      const local = JSON.parse(localStorage.getItem('guests')||'[]');
      const localMy = local.filter(g=>g.userId===currentUser);
      renderMyGuests(serverMy.concat(localMy));
    }).catch(()=> {
      const local = JSON.parse(localStorage.getItem('guests')||'[]');
      const localMy = local.filter(g=>g.userId===currentUser);
      renderMyGuests(localMy);
    });
  }

  function renderMyGuests(list){
    myGuestsList.innerHTML = '';
    if (!list || list.length === 0){ myGuestsList.innerHTML = '<p>您尚未提交参加信息</p>'; return; }
    list.forEach(guest=>{
      const div = document.createElement('div'); div.className='guest-item';
      div.innerHTML = `
        <div class="guest-info">
          <strong>${escapeHtml(guest.name||'')}</strong> (${escapeHtml(guest.phone||'')})<br>
          人数: ${escapeHtml(String(guest.count||'1'))}
          ${guest.note ? '<br>备注: ' + escapeHtml(guest.note) : ''}
          <br><small>${escapeHtml(String(guest.time||''))}</small>
        </div>
      `;
      myGuestsList.appendChild(div);
    });
  }

  // init
  loadUserGuests();

  /* --- Confetti (visual only, don't block events) --- */
  function createConfettiBurst(){
    const colors = ['#d4af37','#ff6b6b','#48dbfb','#1dd1a1','#f368e0'];
    for (let i=0;i<30;i++){
      const c = document.createElement('div');
      c.className='confetti';
      c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      // place above viewport
      c.style.left = Math.random()*100 + 'vw';
      c.style.top = '-10px';
      const s = (Math.random()*8+6);
      c.style.width = s+'px'; c.style.height = s+'px';
      c.style.transform = `rotate(${Math.random()*360}deg)`;
      // animation using transition + transform to avoid keyframe duplication
      document.body.appendChild(c);
      const fallTime = Math.random()*2000+2500;
      // use requestAnimationFrame to trigger
      requestAnimationFrame(()=> {
        c.style.transition = `transform ${fallTime}ms linear, opacity ${fallTime}ms linear`;
        c.style.transform = `translateY(${window.innerHeight + 200}px) rotate(${Math.random()*720}deg)`;
        c.style.opacity = '0';
      });
      setTimeout(()=> c.remove(), fallTime+200);
    }
  }
  // start periodic confetti but not too often
  createConfettiBurst();
  setInterval(createConfettiBurst, 4000);

  // expose for debugging if needed
  window._rsvp_reload = ()=>{ loadUserGuests(); loadAdminGuests(); };

}); // DOMContentLoaded end
</script>
</body>
</html>


