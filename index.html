<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>张天一升学宴邀请函</title>
    <style>
        /* 你的原始样式基本保留，只微调透明度以便表格可读 */
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: #f9f3e9; color: #333; margin:0; padding:0;
            background-image: url('https://img.freepik.com/free-vector/elegant-gold-background_52683-62728.jpg');
            background-size: cover; background-attachment: fixed; }
        .container { max-width:800px; margin:0 auto; padding:30px; background-color: rgba(255,255,255,0.95);
            box-shadow:0 0 20px rgba(0,0,0,0.1); border-radius:10px; margin-top:50px; margin-bottom:50px; position: relative; overflow:hidden;}
        .header { text-align:center; margin-bottom:30px; position:relative; }
        .title { font-size:48px; color:#d4af37; margin:20px 0; text-shadow:2px 2px 4px rgba(0,0,0,0.2); font-weight:bold; }
        .divider { height:3px; background:linear-gradient(to right, transparent, #d4af37, transparent); margin:20px 0; }
        .content { line-height:1.8; font-size:18px; text-align:justify; }
        .highlight { color:#d4af37; font-weight:bold; }
        .footer { text-align:right; margin-top:40px; font-size:16px; position:relative; }
        .btn-container { text-align:center; margin-top:40px; }
        .btn { display:inline-block; padding:12px 30px; background-color:#d4af37; color:white; text-decoration:none; border-radius:50px;
            font-size:18px; transition:all .3s; border:none; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin:5px; }
        .btn:hover { background-color:#c9a227; transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
        .btn.admin { background-color:#6c757d; position:absolute; right:0; bottom:0; padding:8px 15px; font-size:14px; }
        .btn.danger { background-color:#dc3545; }
        .modal { display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); }
        .modal-content { background-color:#fefefe; margin:10% auto; padding:30px; border:1px solid #888; width:80%; max-width:800px; border-radius:10px;
            box-shadow:0 5px 15px rgba(0,0,0,0.3); max-height:80vh; overflow-y:auto; }
        .close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
        .close:hover { color:black; }
        .form-group { margin-bottom:20px; }
        label { display:block; margin-bottom:8px; font-weight:bold; }
        input, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:16px; }
        .guests-list { margin-top:20px; border-top:1px solid #eee; padding-top:20px; }
        .guest-item { padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        .guest-info { flex:1; }
        .guest-actions { margin-left:20px; }
        .confetti { position:absolute; width:10px; height:10px; background-color:#d4af37; opacity:0.7; border-radius:50%; }
        .stats { display:flex; justify-content:space-around; margin-bottom:20px; font-size:18px; }
        .stat-item { text-align:center; padding:10px; background-color:#e9ecef; border-radius:5px; min-width:100px; }
        .stat-value { font-size:24px; font-weight:bold; color:#d4af37; }
        .admin-login { text-align:center; margin-top:20px; }
        .password-input { margin:10px 0; padding:8px; width:200px; border-radius:4px; border:1px solid #ddd; }
        .user-view { margin-top:30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">升学宴</div>
            <div class="divider"></div>
        </div>

        <div class="content">
            <p>尊敬的_______：</p>
            <p>您好！</p>
            <p>春华秋实，硕果累累。在这个收获的季节里，我们怀着无比喜悦的心情与您分享一个好消息——小女<span class="highlight">张天一</span>经过多年的勤奋努力，在2024年高考中取得了优异的成绩，并荣幸地被<span class="highlight">宁夏大学</span>录取。</p>
            <p>为了感谢各位亲朋好友一直以来的关心与支持，我们诚挚邀请您参加她的升学宴，共同见证这一重要时刻，分享我们的喜悦与感恩。</p>
            <p><strong>时间：</strong>2024年8月16日（星期五）晚上</p>
            <p><strong>地点：</strong>和泰宾馆（具体厅位可现场咨询）</p>
            <p>您的到来将为我们的宴会增添无限光彩！期待与您共聚一堂，同庆同乐！</p>
        </div>

        <div class="footer">
            <p>家长：<span class="highlight">张世盾、牛小合</span> 敬邀</p>
            <p>联系电话：13995440435，15709640855</p>
            <button class="btn admin" id="adminModeBtn">管理员模式</button>
        </div>

        <div class="btn-container">
          <button class="btn" id="attendBtn" onclick="document.getElementById('attendModal').style.display='block'">参加宴会</button>


        </div>

        <div class="user-view" id="userView">
            <h3>我的报名信息</h3>
            <div id="myGuestsList"></div>
        </div>
    </div>

    <!-- 参加宴会模态框 -->
    <div id="attendModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>参加宴会登记</h2>
            <div class="form-group">
                <label for="name">您的姓名</label>
                <input type="text" id="name" placeholder="请输入您的姓名">
            </div>
            <div class="form-group">
                <label for="phone">联系电话</label>
                <input type="text" id="phone" placeholder="请输入您的联系电话">
            </div>
            <div class="form-group">
                <label for="count">参加人数</label>
                <input type="number" id="count" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="note">备注</label>
                <textarea id="note" rows="3" placeholder="如有特殊需求请在此备注"></textarea>
            </div>
            <button class="btn" id="submitBtn">提交</button>
        </div>
    </div>

    <!-- 管理员面板模态框 -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>管理员面板</h2>

            <div class="stats">
                <div class="stat-item">
                    <div>总条目</div>
                    <div class="stat-value" id="totalGuests">0</div>
                </div>
                <div class="stat-item">
                    <div>总宾客数</div>
                    <div class="stat-value" id="totalPeople">0</div>
                </div>
            </div>

            <div class="guests-list" id="adminGuestsList">
                <h3>所有宾客名单</h3>
            </div>
        </div>
    </div>

    <!-- 管理员登录模态框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>管理员登录</h2>
            <div class="admin-login">
                <p>请输入管理员密码</p>
                <input type="password" id="adminPassword" class="password-input" placeholder="密码">
                <div>
                    <button class="btn" id="loginBtn">登录</button>
                </div>
                <p id="loginError" style="color: red; display: none;">密码错误，请重试</p>
            </div>
        </div>
    </div>

<script>
/*
  已配置的 Google Apps Script 地址（你在对话里给的部署地址）
  如果你以后重新部署或换别的脚本，请改这里。
*/
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzhgNpxpuB8nRTSnG52ndcW7K1uXokaGpJRLH6em1l0OcPvHIjwixCfxL88Hw7mbyFx/exec';

// 管理员前端密码（仅做界面控制，不是真正安全验证）
const ADMIN_PASSWORD = "306000";

// DOM
const attendModal = document.getElementById("attendModal");
const adminModal = document.getElementById("adminModal");
const loginModal = document.getElementById("loginModal");
const attendBtn = document.getElementById("attendBtn");
const adminModeBtn = document.getElementById("adminModeBtn");
const closeBtns = document.getElementsByClassName("close");
const submitBtn = document.getElementById("submitBtn");
const loginBtn = document.getElementById("loginBtn");
const adminGuestsList = document.getElementById("adminGuestsList");
const totalGuests = document.getElementById("totalGuests");
const totalPeople = document.getElementById("totalPeople");
const myGuestsList = document.getElementById("myGuestsList");

// currentUser 保存在 localStorage，用于区分谁提交的
let currentUser = localStorage.getItem('currentUser') || generateUserId();
if (!localStorage.getItem('currentUser')) localStorage.setItem('currentUser', currentUser);
function generateUserId(){ return 'user_' + Math.random().toString(36).substr(2,9); }

// 打开/关闭模态框逻辑（保留你的原来行为）
attendBtn.onclick = () => attendModal.style.display = "block";
adminModeBtn.onclick = () => loginModal.style.display = "block";
for (let i=0;i<closeBtns.length;i++){
    closeBtns[i].onclick = function(){
        attendModal.style.display = "none";
        adminModal.style.display = "none";
        loginModal.style.display = "none";
        document.getElementById("loginError").style.display = "none";
    }
}
window.onclick = function(event){
    if (event.target == attendModal) attendModal.style.display = "none";
    if (event.target == adminModal) adminModal.style.display = "none";
    if (event.target == loginModal) loginModal.style.display = "none";
}

// 表单提交：优先写入 Google Sheets（通过 Apps Script），失败时回退到 localStorage
submitBtn.onclick = function(){
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const count = document.getElementById("count").value;
    const note = document.getElementById("note").value.trim();

    if (!name || !phone) { alert("请填写姓名和联系电话"); return; }

    const guest = { name, phone, count, note, time: new Date().toLocaleString(), userId: currentUser };

    // 先尝试写到 Google Sheets（Apps Script）
    fetch(SHEET_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(guest)
    }).then(res => {
        // Apps Script 我们期望返回 JSON；即便不返回也算成功
        // 清空表单并提示
        document.getElementById("name").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("count").value = "1";
        document.getElementById("note").value = "";
        alert("提交成功！感谢您的参与！");
        attendModal.style.display = "none";
        // 重新加载用户视图
        loadUserGuests();
    }).catch(err => {
        // 网络或 CORS 问题：回退到 localStorage
        let guests = JSON.parse(localStorage.getItem('guests')) || [];
        guests.push(guest);
        localStorage.setItem('guests', JSON.stringify(guests));
        localStorage.setItem('currentUser', guest.userId);
        alert("网络异常，记录已保存在本地。请在有网时重新提交。");
        attendModal.style.display = "none";
        loadUserGuests();
    });
};

// 管理员登录（仅前端界面控制）
loginBtn.onclick = function() {
    const password = document.getElementById("adminPassword").value;
    if (password === ADMIN_PASSWORD) {
        loginModal.style.display = "none";
        adminModal.style.display = "block";
        document.getElementById("adminPassword").value = "";
        document.getElementById("loginError").style.display = "none";
        loadAdminGuests();
    } else {
        document.getElementById("loginError").style.display = "block";
    }
};

// 读取所有宾客（管理员视图）——优先从 Google 表格读取，兼容多种返回格式
function loadAdminGuests(){
    adminGuestsList.innerHTML = '<h3>所有宾客名单</h3>';
    // 首先尝试从服务器拉取
    fetch(SHEET_URL).then(res => res.json()).then(data => {
        // Apps Script 可能返回两种格式：
        // 1) 数组 of 对象 [{name:..., phone:..., _row:...}, ...]
        // 2) 二维数组 (rows) [['name','phone',...], ['张三','139...'], ...]
        let rows = [];

        if (!data) data = [];

        if (Array.isArray(data) && data.length>0 && typeof data[0] === 'object' && !Array.isArray(data[0])) {
            // case 1: already objects (we expect each object has fields and _row)
            rows = data.map(obj => obj);
        } else if (Array.isArray(data) && data.length>0 && Array.isArray(data[0])) {
            // case 2: first row is headers
            const headers = data[0].map(h => String(h));
            for (let i = 1; i < data.length; i++){
                const r = data[i];
                const obj = {};
                for (let j = 0; j < headers.length; j++){
                    obj[headers[j]] = r[j];
                }
                obj._row = i + 1; // 表格真实行号（用于 delete）
                rows.push(obj);
            }
        } else {
            // 其它情况：当作空
            rows = [];
        }

        renderAdminList(rows);
    }).catch(err => {
        // 读取失败 -> 退回到 localStorage 保存的数据
        const guests = JSON.parse(localStorage.getItem('guests')) || [];
        // 将本地数据格式化成与 server 一样的对象数组（但没有 _row）
        const rows = guests.map((g, idx) => Object.assign({}, g, { _row: null }));
        renderAdminList(rows);
    });
}

function renderAdminList(rows){
    adminGuestsList.innerHTML = '<h3>所有宾客名单</h3>';
    if (!rows || rows.length === 0) {
        adminGuestsList.innerHTML += '<p>暂无宾客信息</p>';
        totalGuests.textContent = 0;
        totalPeople.textContent = 0;
        return;
    }

    let totalPeopleCount = 0;
    rows.forEach((guest) => totalPeopleCount += parseInt(guest.count) || 0);
    totalGuests.textContent = rows.length;
    totalPeople.textContent = totalPeopleCount;

    rows.forEach((guest, idx) => {
        const guestItem = document.createElement('div');
        guestItem.className = 'guest-item';
        const noteHtml = guest.note ? ('<br>备注: ' + escapeHtml(guest.note)) : '';
        const timeHtml = guest.time ? ('<br><small>' + escapeHtml(String(guest.time)) + '</small>') : '';
        const rowNum = guest._row || ''; // 如果没有 _row（本地数据）则为空

        guestItem.innerHTML = `
            <div class="guest-info">
                <strong>${escapeHtml(guest.name || '')}</strong> (${escapeHtml(guest.phone || '')})
                <br>人数: ${escapeHtml(String(guest.count || '1'))}
                ${noteHtml}
                ${timeHtml}
            </div>
            <div class="guest-actions">
                ${ rowNum ? `<button class="btn danger" onclick="deleteGuest(${rowNum})">删除</button>` : `<button class="btn danger" onclick="deleteLocalGuest(${idx})">删除(本地)</button>` }
            </div>
        `;
        adminGuestsList.appendChild(guestItem);
    });
}

// 加载当前用户自己的提交：优先从服务器筛选 userId，然后合并本地缓存
function loadUserGuests(){
    myGuestsList.innerHTML = '';
    // 合并服务器和本地保存
    fetch(SHEET_URL).then(res => res.json()).then(data => {
        let rows = [];
        if (Array.isArray(data) && data.length>0 && typeof data[0] === 'object' && !Array.isArray(data[0])) {
            rows = data;
        } else if (Array.isArray(data) && data.length>0 && Array.isArray(data[0])) {
            const headers = data[0].map(h => String(h));
            for (let i = 1; i < data.length; i++){
                const r = data[i];
                const obj = {};
                for (let j = 0; j < headers.length; j++){
                    obj[headers[j]] = r[j];
                }
                obj._row = i + 1;
                rows.push(obj);
            }
        } else {
            rows = [];
        }

        const serverMy = rows.filter(g => g.userId === currentUser);
        const local = JSON.parse(localStorage.getItem('guests')) || [];
        const localMy = local.filter(g => g.userId === currentUser);
        renderMyGuests(serverMy.concat(localMy));
    }).catch(err => {
        // 网络失败只显示本地
        const local = JSON.parse(localStorage.getItem('guests')) || [];
        const localMy = local.filter(g => g.userId === currentUser);
        renderMyGuests(localMy);
    });
}

function renderMyGuests(list){
    myGuestsList.innerHTML = '';
    if (!list || list.length === 0) {
        myGuestsList.innerHTML = '<p>您尚未提交参加信息</p>';
        return;
    }
    list.forEach(guest => {
        const guestItem = document.createElement('div');
        guestItem.className = 'guest-item';
        guestItem.innerHTML = `
            <div class="guest-info">
                <strong>${escapeHtml(guest.name || '')}</strong> (${escapeHtml(guest.phone || '')})<br>
                人数: ${escapeHtml(String(guest.count || '1'))}
                ${guest.note ? '<br>备注: ' + escapeHtml(guest.note) : ''}
                <br><small>${escapeHtml(String(guest.time || ''))}</small>
            </div>
        `;
        myGuestsList.appendChild(guestItem);
    });
}

// 删除服务器端记录（管理员操作），Apps Script 接受 { action: 'delete', row: N }
window.deleteGuest = function(row) {
    if (!confirm('确定要删除这条记录吗？')) return;
    fetch(SHEET_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', row: row })
    }).then(res => res.json()).then(r => {
        // 重新加载
        loadAdminGuests();
        loadUserGuests();
    }).catch(err => {
        alert('删除失败，请检查网络或 Apps Script 权限设置。');
    });
};

// 删除本地保存记录（仅当管理员查看本地备份时用）
window.deleteLocalGuest = function(index) {
    if (!confirm('确定要删除本地这条记录吗？')) return;
    let guests = JSON.parse(localStorage.getItem('guests')) || [];
    guests.splice(index, 1);
    localStorage.setItem('guests', JSON.stringify(guests));
    loadAdminGuests();
    loadUserGuests();
};

// XSS 预防：把字符串里的特殊字符转义成 HTML 实体（用于简单输出）
function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[m]; });
}

/* 五彩纸屑效果（保留） */
function createConfetti() {
    const colors = ['#d4af37', '#ff6b6b', '#48dbfb', '#1dd1a1', '#f368e0'];
    for (let i = 0; i < 40; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-10px';
        const size = Math.random() * 10 + 5;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
        document.body.appendChild(confetti);

        const keyframes = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(${Math.random() * 360}deg);
                    opacity: 0;
                }
            }
        `;
        const style = document.createElement('style');
        style.innerHTML = keyframes;
        document.head.appendChild(style);

        setTimeout(() => { confetti.remove(); style.remove(); }, 5000);
    }
}

// 页面加载初始化
window.onload = function(){
    createConfetti();
    setInterval(createConfetti, 3000);
    loadUserGuests();
    // 注意：如果本地没有 currentUser，会在上面生成并保存
};
</script>
</body>
</html>

